<section class="row">
    <h2 class="title-payment">Formas de pagamento</h2>
    <h4 class="method-payment">Escolha o método</h4>
    <nav class="tabs-pagseguro clearfix" id="tabs-payment">
        <ul class="items clearfix">
            <li class="item --active">
                <a class="action js-tab-action" href="#credit-card">
                    <i class="fa fa-credit-card fa-4x"></i>
                    <span class="name">Cartão de Crédito</span>
                </a>
            </li><!-- /.item -->
            <li class="item">
                <a class="action js-tab-action" href="#debit-online">
                    <i class="fa fa-money fa-4x"></i>
                    <span class="name">Débito Online</span>
                </a>
            </li><!-- /.item -->
            <li class="item">
                <a class="action js-tab-action" href="#bilet">
                    <i class="fa fa-barcode fa-4x"></i>
                    <span class="name">Boleto</span>
                </a>
            </li><!-- /.item -->
        </ul><!-- /.items -->
    </nav><!-- /.tabs-payment -->
    <div class="tabs-content col-xs-12 col-md-8 col-md-offset-2">
        <div class="item-tab --current" id="credit-card">
            <h3 class="title-tab">Cartão de Crédito</h3>
            <form class="form-horizontal clearfix" name="form-credit">
                <div class="form-group">
                    <label class="col-xs-12 col-sm-2 control-label" for="card_cod">CPF/CNPJ</label>
                    <div class="col-xs-12 col-sm-10">
                        <input class="form-control cpf-cnpj-mask" id="document-credit-card" name="document" type="text">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-xs-12 col-sm-2 control-label" for="card_num">Número do cartão</label>
                    <div class="col-xs-12 col-sm-10">
                        <input class="form-control credit-card-mask" id="card_num" name="card_num" type="text" required>
                    </div>
                </div><!-- /.form-group -->
                <div class="form-group">
                    <label class="col-xs-12 col-sm-2 control-label" for="card_holder_name">Nome impresso no cartão</label>
                    <div class="col-xs-12 col-sm-10">
                        <input class="form-control" id="card_holder_name" name="card_holder_name" type="text" required>
                    </div>
                </div><!-- /.form-group -->
                <div class="form-group">
                    <label class="col-xs-12 col-sm-2 control-label" for="card_holder_birthdate">Data de nascimento</label>
                    <div class="col-xs-12 col-sm-10">
                        <input class="form-control date-mask" id="card_holder_birthdate" name="card_holder_birthdate" type="text" required="">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-xs-12 col-sm-2 control-label" for="card_validate">Validade</label>
                    <div class="col-xs-12 col-sm-10">
                        <div class="row form-inline-childs">
                            <div class="col-xs-12 col-sm-6">
                                <select class="form-control" id="card_expiration_month" name="card_validate">
                                    <option value="" disabled selected>Mês</option>
                                    <option value="01">01</option>
                                    <option value="02">02</option>
                                    <option value="03">03</option>
                                    <option value="04">04</option>
                                    <option value="05">05</option>
                                    <option value="06">06</option>
                                    <option value="07">07</option>
                                    <option value="08">08</option>
                                    <option value="09">09</option>
                                    <option value="10">10</option>
                                    <option value="11">11</option>
                                    <option value="12">12</option>
                                </select>
                            </div>
                            <div class="col-xs-12 col-sm-6">
                                <select id="card_expiration_year" name="card_validate" class="form-control">
                                    <option value="" disabled selected>Ano</option>
                                    <?php
                                        $year = idate("Y");
                                        $maxYear = $year + 20;
                                        for ($i = $year; $i < $maxYear; $i++): ?>
                                    <option value="<?=$i;?>"><?=$i;?></option>
                                    <?php endfor; ?>
                                </select>
                            </div>
                        </div>
                    </div>
                </div><!-- /.form-group -->
                <div class="form-group">
                    <label class="col-xs-12 col-sm-2 control-label" for="card_cod">Código de segurança</label>
                    <div class="col-xs-12 col-sm-10">
                        <input class="form-control code-card-mask" id="card_cod" name="card_cod" type="text">
                    </div>
                </div><!-- /.form-group -->
                <div class="form-group display-none">
                    <label class="col-xs-12 col-sm-2 control-label" for="card_installments">Parcelas</label>
                    <div class="col-xs-12 col-sm-10">
                        <select id="card_installments" name="card_installments" class="form-control">
                            <option value="" disabled selected>Escolha o N° de parcelas</option>
                        </select>
                    </div>
                </div>
                <div class="form-group credit-total display-none">
                    <label class="col-xs-12 col-sm-2 control-label" for="card_installments">Total</label>
                    <div class="col-xs-12 col-sm-10">
                        <span id="card_total">R$ 00,00</span>
                    </div>
                </div>
                <button class="btn-pagseguro --align-right" id="payment-credit-card">Concluir</button>
            </form>
        </div><!-- /.item-tab#credit-card -->
        <div class="item-tab" id="debit-online">
            <h3 class="title-tab">Débito On-line</h3>
            <form class="form-horizontal clearfix" name="form-debit">
                <div class="form-group">
                    <label class="col-xs-12 col-sm-2 control-label" for="card_cod">CPF/CNPJ</label>
                    <div class="col-xs-12 col-sm-10">
                        <input class="form-control cpf-cnpj-mask" id="document-debit" name="document" type="text">
                    </div>
                </div><!-- /.form-group -->
                <div class="form-group">
                    <label class="col-xs-12 col-sm-6 control-label">Escolha seu banco abaixo onde deverá fazer o pagamento online.</label>
                    <div id="bankList" class="col-xs-12 col-sm-5 col-sm-offset-1">
                        <label class="radio">
                            <input type="radio" name="bank" id="optionsRadios1" value="1">
                            Itaú
                        </label>
                        <!-- <label class="radio">
                            <input type="radio" name="bank" id="optionsRadios2" value="2">
                            Bradesco
                        </label> -->
                        <label class="radio">
                            <input type="radio" name="bank" id="optionsRadios2" value="3">
                            Banrisul
                        </label>
                        <label class="radio">
                            <input type="radio" name="bank" id="optionsRadios2" value="4">
                            Banco do Brasil
                        </label>
                        <label class="radio">
                            <input type="radio" name="bank" id="optionsRadios2" value="5">
                            HSBC
                        </label>
                    </div>
                </div><!-- /.form-group -->
                <button class="btn-pagseguro --align-right" id="payment-debit">Concluir</button>
            </form>
        </div><!-- /.item-tab#debit-online -->
        <div class="item-tab" id="bilet">
            <h3 class="title-tab">Boleto</h3>
            <form class="form-horizontal clearfix" name="form-bilit">
                <div class="form-group">
                    <label class="col-xs-12 col-sm-2 control-label" for="card_cod">CPF/CNPJ</label>
                    <div class="col-xs-12 col-sm-10">
                        <input class="form-control cpf-cnpj-mask" id="document-boleto" name="document" type="text">
                    </div>
                </div>
                <button class="btn-pagseguro --align-right" id="payment-boleto">Concluir</button>
            </form>
            <ul class="list-warning">
                <li>Imprima o boleto e pague no banco</li>
                <li>Ou pague pela internet utilizando o código de barras do boleto</li>
                <li>o prazo de validade do boleto é de 1 dia útil</li>
            </ul>
        </div><!-- /.item-tab#bilet -->
    </div><!-- /.tabs-content-->
</section><!-- /.wrapper -->

<input type="hidden" id="adminurl" data-target="<?=$this->getBaseUrl(); ?>"/>
<input type="hidden" id="order" data-target="<?=$this->getOrder(); ?>"/>
<input type="hidden" id="session-code" data-target="<?=$this->getData('sessionCode'); ?>"/>
<input type="hidden" id="card-international" data-target=""/>
<input type="hidden" id="card-brand" data-target=""/>

<script type="text/javascript" src="<?=$this->getData('paymentUrl'); ?>"></script>
<script type="text/javascript">
    require([
            'jquery',
            'masks',
            "public"
        ],
        function($) {
            ;(function masksInputs($, undefined) {
                $('.cpf-mask').mask('000.000.000-00');
                $('.cnpj-mask').mask('00.000.000/0000-00');
                $('.credit-card-mask').mask('0000 0000 0000 0000');
                $('.code-card-mask').mask('000');
                $('.date-mask').mask('00/00/0000', { placeholder: "__/__/____" });
                $('.cpf-cnpj-mask').on('keyup', function() {
                    try {
                        $(this).unmask();
                    } catch(e) {
                        alert('Ops, algo deu errado!');
                    };
                    var isLength = $(this).val().length;
                    //9 is number optional, is fake the transtion two types mask
                    isLength <= 11 ? $(this).mask('000.000.000-009') : $(this).mask('00.000.000/0000-00');
                });
            }($));
            ;(function tabsPagseguro($, undefined) {
                var $action = $('.js-tab-action');
                $action.on('click', function(e){
                    e.preventDefault();
                    var $itemtTab = $(this).parent('.item');
                    var isActive = $itemtTab.hasClass('--active');
                    if(!isActive) {
                        var $newTabId = $($(this).attr('href'));
                        $('#tabs-payment .item.--active').removeClass('--active'); //remove class the old tab selected
                        $('.item-tab.--current').removeClass('--current');
                        //add new tab selected
                        $itemtTab.addClass('--active');
                        $newTabId.addClass('--current');
                    } else {
                        return false;
                    }
                });
            }($));
            ;(function calcTotal($, undefined) {
                //Update the total value according with installments
                $('#card_installments').on('change', function() {
                    var currency = parseFloat($(this).val()).toFixed(2);
                    $('#card_total').text('R$ ' + currency);
                });
            }($));
            function loadElements(service, bank, creditCard) {
                var bank = bank || false;
                var creditCard = creditCard || false;
                var data = [];
                //start request process started
                $("#payment-"+service).trigger('processStart');
                //default values to send
                data['url'] = $('#adminurl').attr('data-target');
                data['orderId'] = $('#order').attr('data-target');
                data['sessionCode'] = $('#session-code').attr('data-target');
                data['document'] = unmaskField($('#document-'+service));
                //values only debit method to use
                if(bank) {
                    var bankId = $("#bankList input[type='radio']:checked");
                    if (bankId.length > 0) {
                        data['bank'] = bankId.val();
                    }
                }
                //values only credit card method to use
                if(creditCard) {
                    data['cardInternational'] = $('#card-international').attr('data-target');
                    data['installmentQuantity'] = $("#card_installments option:selected" ).attr('data-quantity');
                    data['installmentAmount'] = $("#card_installments option:selected" ).attr('data-amount');
                    data['holderName'] = $('#card_holder_name').val();
                    data['holderBirthdate'] = $('#card_holder_birthdate').val();
                }
                return data;
            };
            //Event buttons methods buy types
            $('#payment-boleto').on('click', function(e){
                e.preventDefault();
                var el = loadElements('boleto');
                PagSeguroDirectPayment.setSessionId(el.sessionCode);
                var hash = PagSeguroDirectPayment.getSenderHash();
                WS.Ajax.Direct.Boleto.Payment(el.url, el.orderId, hash, el.document);
            });
            $('#payment-debit').on('click', function(e){
                e.preventDefault();
                var el = loadElements('debit', true);
                PagSeguroDirectPayment.setSessionId(el.sessionCode);
                var hash = PagSeguroDirectPayment.getSenderHash();
                WS.Ajax.Direct.OnlineDebit.Payment(el.url, el.orderId, hash, el.document, el.bank);
            });
            $('#payment-credit-card').on('click', function(e){
                e.preventDefault();
                PagSeguroDirectPayment.createCardToken({
                    cardNumber: unmaskField($('#card_num')),
                    brand: $('#card-brand').attr('data-target'),
                    internationalMode: $('#card-international').attr('data-target'),
                    cvv: $('#card_cod').val(),
                    expirationMonth: $('#card_expiration_month').val(),
                    expirationYear: $('#card_expiration_year').val(),
                    success: function(response) {
                        var el = loadElements('credit-card', false, true);
                        var token = response.card.token;
                        var hash = PagSeguroDirectPayment.getSenderHash();
                        setTimeout(function () {
                            WS.Ajax.Direct.CreditCard.Payment(
                                el.url,
                                el.orderId,
                                hash,
                                el.document,
                                token,
                                el.cardInternational,
                                el.installmentQuantity,
                                el.installmentAmount,
                                el.holderName,
                                el.holderBirthdate
                            );
                        }, 5000);
                    }
                });
            });
            //get and showing brand credit card
            function getBrandCard(cardBinVal) {
                PagSeguroDirectPayment.setSessionId($('#session-code').attr('data-target'));
                PagSeguroDirectPayment.getBrand({
                    cardBin: cardBinVal,
                    internationalMode: true,
                    success: function(response) {
                        WS.Ajax.Direct.CreditCard.Installments(
                            $('#adminurl').attr('data-target'),
                            $('#order').attr('data-target'),
                            response.brand.name,
                            response.brand.international
                        );
                    }
                });
            };
            function unmaskField($el, val = true) {
                try {
                    if (val === true) {
                        var $el = $el.val();
                    }
                    return $el.replace(/[/ -. ]+/g, '').trim();
                } catch(e) {
                    alert('Ops, algo deu errado! Recarregue a página');
                };
            };

            ;(function()
            {
                var kbinValue,
                    klength = 0,
                    klastLength = 0,
                    kunMasked;
                $('#card_num').on('keyup', function () {
                    klastLength = klength;
                    klength = $(this).val().length;
                    //6 number + space of mask
                    if (klength == 7 && klastLength <= 7) {
                        kunMasked = unmaskField($(this).val(), false);
                        kbinValue = kunMasked.substring(0,6);
                        getBrandCard(kbinValue);
                    }
                });
            }($));

            ;(function()
            {
                $('#card_num').on('paste', function (e) {
                    e.preventDefault();
                    return false;
                });
            }($));
        }
    );
</script>

